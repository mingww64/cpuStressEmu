<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive CPU Thermal Performance Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- marked-katex-extension -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked-katex-extension@5.1.4/lib/index.umd.js"></script>


    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; height: 400px; max-height: 50vh; }
        .nav-button { transition: all 0.2s ease-in-out; }
        .nav-button.active { color: #0284c7; border-color: #0284c7; font-weight: 600; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .stat-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); text-align: center; }
        .stat-card-title { font-weight: 500; color: #475569; }
        .stat-card-value { font-weight: 700; color: #0f172a; font-size: 1.875rem; line-height: 2.25rem; }
        .stat-card-unit { font-size: 1rem; color: #64748b; margin-left: 0.25rem; }
        .file-upload-section { text-align: center; padding: 1.5rem; background-color: #f8fafc; border-radius: 0.5rem; margin-bottom: 1rem; border: 2px dashed #cbd5e1; }
        .file-input { display: block; margin: 0.5rem auto; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; max-width: 300px; }
        .charts-disabled-overlay { position: absolute; top:0; left:0; right:0; bottom:0; background-color: rgba(241, 245, 249, 0.8); display:flex; align-items:center; justify-content:center; text-align:center; z-index:10; border-radius: 0.5rem;}
        
        /* Styles for the Markdown content area */
        #detailsMarkdownHost { padding: 1rem; background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        #detailsMarkdownHost h1, #detailsMarkdownHost h2, #detailsMarkdownHost h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        #detailsMarkdownHost h1 { font-size: 1.875rem; } 
        #detailsMarkdownHost h2 { font-size: 1.5rem; }   
        #detailsMarkdownHost h3 { font-size: 1.25rem; }  
        #detailsMarkdownHost p { margin-bottom: 1em; line-height: 1.6; color: #475569; }
        #detailsMarkdownHost ul, #detailsMarkdownHost ol { margin-left: 1.5em; margin-bottom: 1em; color: #475569; list-style-position: inside; } 
        #detailsMarkdownHost li { margin-bottom: 0.25em; }
        #detailsMarkdownHost a { color: #0284c7; text-decoration: underline; }
        #detailsMarkdownHost strong { font-weight: 600; }
        #detailsMarkdownHost em { font-style: italic; }
        #detailsMarkdownHost code { background-color: #f1f5f9; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
        #detailsMarkdownHost pre { background-color: #f1f5f9; padding: 1em; border-radius: 0.5rem; overflow-x: auto; }
        #detailsMarkdownHost pre code { background-color: transparent; padding: 0; margin: 0; font-size: inherit; border-radius: 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-2xl md:text-4xl font-bold text-slate-900">A Thermodynamic Investigation of CPU Cooling</h1>
            <p class="text-md md:text-lg text-slate-600 mt-2">Interactive Analysis of the Noctua NH-L9a on AMD Ryzen 4650G</p>
        </header>

        <div id="topUploadContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div id="dataUploadSection" class="file-upload-section">
                <h2 class="text-xl font-semibold mb-2 text-slate-700">1. Load Experiment Data (CSV)</h2>
                <p class="text-slate-500 mb-3 text-sm">Select a CSV file or use the default loaded data.</p>
                <input type="file" id="csvFileInput" class="file-input" accept=".csv">
                <p id="csvFileStatus" class="text-sm text-slate-500 mt-1">Attempting to load default CSV...</p>
            </div>
            <div id="mdUploadSection" class="file-upload-section">
                <h2 class="text-xl font-semibold mb-2 text-slate-700">2. Load Details (Markdown)</h2>
                <p class="text-slate-500 mb-3 text-sm">Select an MD file or use the default loaded content.</p>
                <input type="file" id="mdFileInput" class="file-input" accept=".md,.txt">
                <p id="mdFileStatus" class="text-sm text-slate-500 mt-1">Attempting to load default Markdown...</p>
            </div>
        </div>
        
        <nav id="mainNav" class="mb-8 border-b border-slate-200 hidden">
            <ul class="flex flex-wrap -mb-px justify-center text-sm font-medium text-center text-slate-500">
                <li class="mr-2">
                    <button class="nav-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-slate-600 hover:border-slate-300" data-tab="overview">Overview</button>
                </li>
                <li class="mr-2">
                    <button class="nav-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-slate-600 hover:border-slate-300" data-tab="performance">Performance Explorer</button>
                </li>
                <li class="mr-2">
                    <button class="nav-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-slate-600 hover:border-slate-300" data-tab="model">Thermal Model</button>
                </li>
                <li>
                    <button class="nav-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-slate-600 hover:border-slate-300" data-tab="details">Experiment Details</button>
                </li>
            </ul>
        </nav>

        <main id="mainContent" class="hidden">
            <div id="overview" class="content-section">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-center">Key Findings</h2>
                    <p class="text-center text-slate-600 mb-8">This experimental investigation successfully characterized the thermal performance of the CPU cooling system. Below are the primary conclusions drawn from the analysis.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="stat-card">
                            <h3 class="stat-card-title">Airflow Dependence</h3>
                            <p id="statAirflow" class="stat-card-value text-sky-600">N/A</p>
                            <p class="text-slate-500 mt-2">Higher fan speeds significantly improve cooling performance and lower thermal resistance.</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="stat-card-title">Physics-Based Model</h3>
                            <p id="statModel" class="stat-card-value text-base md:text-lg lg:text-xl p-1">N/A</p>
                            <p class="text-slate-500 mt-2">A model was successfully fitted, accurately describing thermal resistance as a function of fan RPM.</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="stat-card-title">Operational "Sweet Spot"</h3>
                            <p id="statSweetSpot" class="stat-card-value">N/A<span class="stat-card-unit">RPM</span></p>
                            <p class="text-slate-500 mt-2">Beyond this point, increasing fan speed offers diminishing returns on cooling improvement.</p>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-semibold text-center mb-4">Conclusion Summary</h3>
                        <ul class="list-disc list-inside space-y-2 text-slate-700">
                            <li><span class="font-semibold">Power Impact:</span> CPU temperature directly correlates with power consumption, a relationship clearly modulated by fan speed.</li>
                            <li><span class="font-semibold">Power Target Tracking:</span> The CPU generally met its set power targets, with only minor deviations observed under various thermal loads. It is worth mentioning that the maximum power consumption is around 50W; therefore, Power Target no longer controls the package power after that. (See Performance Explorer.)</li>
                            <li><span class="font-semibold">Primarily Convection-Based Cooling:</span> The fitted physics model (R<sub>th</sub> = R<sub>fixed</sub> + C / RPM<sup>n</sup>) demonstrates that the cooler's performance is overwhelmingly governed by convection. The significant C / RPM<sup>n</sup> term, which directly relates to airflow (RPM), and a near-zero fitted R<sub>fixed</sub> value, indicate that heat dissipation is primarily achieved by air moving over the heatsink fins. (See Experiment Details and Play around in Thermal Model!)</li>
                            <li><span class="font-semibold">Verification:</span> The above result should be replicable, if you also use Linux and have an Ryzen CPU, feel free to verify yourself with your own data.</li>

                        </ul>
                    </div>
                </div>
            </div>

            <div id="performance" class="content-section">
                <div class="space-y-12">
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">CPU Temperature vs. Actual Power</h2>
                        <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">This chart shows how CPU temperature increases with power consumption. Higher fan speeds (cooler colors) usually result in lower temperatures for the same power load. However, this is not apparent in this graph because the fan speed is dynamically controlled by temperature.</p>
                        <div class="chart-container"><canvas id="tempVsPowerChart"></canvas></div>
                        <div id="tempVsPowerOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">CPU Temperature vs. CPU Fan RPM</h2>
                        <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">This chart illustrates the direct impact of fan speed on temperature. The cooling effect is most pronounced at higher power loads (brighter colors), with diminishing returns at very high RPMs.</p>
                        <div class="chart-container"><canvas id="tempVsRpmChart"></canvas></div>
                        <div id="tempVsRpmOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">Actual Power vs. Set Power Target</h2>
                         <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">This plot assesses how well the CPU's actual power consumption tracked the targets set during the experiment. The black dashed line represents ideal 1:1 tracking.</p>
                        <div class="chart-container"><canvas id="pptChart"></canvas></div>
                        <div id="pptOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                </div>
            </div>

            <div id="model" class="content-section">
                 <div class="space-y-12">
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">Thermal Resistance Model</h2>
                        <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">Thermal resistance (R<sub>th</sub>) measures cooling efficiency. A physics-based model was fitted to the data, showing how R<sub>th</sub> decreases as fan RPM increases.</p>
                        <div class="chart-container"><canvas id="rthVsRpmChart"></canvas></div>
                        <div id="rthVsRpmOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                    <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-semibold text-center mb-4">Interactive Model Calculator</h3>
                        <p class="text-center text-slate-600 mb-1">Use the slider to see the predicted thermal resistance based on the model:</p>
                        <p id="modelEquationDisplay" class="text-center font-mono text-sky-700 mb-4">R<sub>th</sub> = C / RPM<sup>n</sup> (Load data for values)</p>
                        <div class="flex items-center space-x-4">
                            <span id="rpmSliderMinLabel" class="font-medium w-20 text-right">300 RPM</span>
                            <input type="range" id="rpmSlider" min="300" max="2500" value="1500" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" disabled>
                            <span id="rpmSliderMaxLabel" class="font-medium w-20 text-left">2500 RPM</span>
                        </div>
                        <div class="text-center mt-4">
                            <p class="text-slate-600">For <span id="rpmValue" class="font-bold text-slate-800">1500</span> RPM, predicted R<sub>th</sub> is:</p>
                            <p class="text-3xl font-bold text-sky-600 mt-1"><span id="rthValue">N/A</span> °C/W</p>
                        </div>
                    </div>
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">Finding the "Sweet Spot"</h2>
                        <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">The "sweet spot" occurs where the benefit of increasing fan speed diminishes. This chart shows the rate of change of R<sub>th</sub>. The curve flattens at higher RPMs, indicating less cooling gain per RPM increase.</p>
                        <div class="chart-container"><canvas id="derivativeChart"></canvas></div>
                        <div id="derivativeOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                 </div>
            </div>

            <div id="details" class="content-section">
                <div class="w-full mx-auto sm:max-w-xl md:max-w-2xl lg:max-w-3xl xl:max-w-4xl 2xl:max-w-5xl">
                    <!-- Heat Transfer Modal -->
                    <div id="heatTransferIntroModal" class="bg-sky-50 p-6 rounded-lg shadow-lg mb-6 border border-sky-200" style="display: none;">
                        <h3 class="text-xl font-semibold text-center mb-4 text-sky-700">Understanding Heat Transfer in CPU Cooling</h3>
                        <p class="text-slate-600 mb-4 text-sm">
                            The cooling of a CPU involves a sequence of heat transfer processes: conduction, convection, and radiation.
                        </p>
                        <div class="space-y-3 text-slate-700 text-left">
                            <div>
                                <h4 class="font-semibold text-slate-700">1. Conduction</h4>
                                <p class="text-sm">Heat conduction is the transfer of thermal energy through a material due to a temperature gradient. In the CPU cooling assembly, this occurs from the silicon die, through Thermal Interface Materials (TIMs) and the Integrated Heat Spreader (IHS), into the cooler's base, along heatpipes to the fin stack, and through the aluminum fins.</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-700">2. Convection</h4>
                                <p class="text-sm">Convection is heat transfer between a solid surface and a moving fluid (air). Forced convection, driven by the CPU fan, is the dominant mode for rejecting heat from the heatsink fins to the surrounding air.</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-700">3. Radiation</h4>
                                <p class="text-sm">Radiative heat transfer occurs via electromagnetic waves. Heat radiates from the heatsink surfaces to cooler components and the case interior. It usually plays a secondary role in forced convection air cooling but can be a factor.</p>
                            </div>
                        </div>
                        <p class="text-slate-600 mt-4 text-sm">
                            These mechanisms form a thermal chain. A bottleneck in any step degrades overall cooling.
                        </p>
                        <div class="text-center mt-6">
                            <button id="dismissHeatTransferIntroButton" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                                I know, I know... Show me the details!
                            </button>
                        </div>
                    </div>

                    <!-- Main Markdown Content Area -->
                    <div id="detailsMarkdownHost" style="display: none;">
                        <!-- Parsed markdown will be injected here -->
                    </div>

                    <!-- Fallback Message for Markdown -->
                    <p id="detailsFallbackMessage" class="text-center text-slate-500 p-6 bg-white rounded-lg shadow-sm">
                        Please upload a Markdown (.md) file to populate this section, or wait for default load.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <div id="bottomFileUploadArea" class="container mx-auto p-4 md:p-8 mt-8 border-t border-slate-200" style="display: none;">
        <h3 class="text-lg font-semibold text-slate-700 mb-3 text-center">Change Loaded Files</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto">
            <div class="file-upload-section !p-4 !mb-0 !border-slate-300">
                <label for="bottomCsvFileInput" class="block text-md font-medium text-slate-600 mb-1">Reload CSV Data:</label>
                <input type="file" id="bottomCsvFileInput" class="file-input !text-sm !max-w-[250px]" accept=".csv">
                <p id="bottomCsvFileStatus" class="text-xs text-slate-500 mt-1">Default CSV loaded.</p>
            </div>
            <div class="file-upload-section !p-4 !mb-0 !border-slate-300">
                <label for="bottomMdFileInput" class="block text-md font-medium text-slate-600 mb-1">Reload Details (MD):</label>
                <input type="file" id="bottomMdFileInput" class="file-input !text-sm !max-w-[250px]" accept=".md,.txt">
                <p id="bottomMdFileStatus" class="text-xs text-slate-500 mt-1">Default Markdown loaded.</p>
            </div>
        </div>
    </div>

    <!-- Page Guide Modal -->
    <div id="pageGuideModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xl transform transition-all">
            <div id="guideHeader" class="mb-4">
                <h2 id="guideSlideTitle" class="text-2xl font-bold text-slate-800">Welcome!</h2>
            </div>
            <div id="guideSlideContent" class="text-slate-700 mb-6 space-y-3 max-h-[60vh] overflow-y-auto">
                <!-- Slide content will be injected here -->
            </div>
            <div id="guideNavigation" class="flex justify-between items-center pt-4 border-t border-slate-200">
                <button id="guidePrevButton" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-2 px-4 rounded-lg transition-colors">Previous</button>
                <span id="guideSlideIndicator" class="text-sm text-slate-500"></span>
                <div class="flex items-center">
                    <button id="guideSkipButton" class="text-slate-500 hover:text-slate-700 font-medium py-2 px-4 rounded-lg mr-2 transition-colors">Skip</button>
                    <button id="guideNextButton" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Next</button>
                    <button id="guideDoneButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors" style="display: none;">Done</button>
                    <button id="guideViewDemoButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg ml-2 transition-colors" style="display: none;">View Demo</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        let processedData = [];
        const activeCharts = {}; 

        // Declare modelParams and sweetSpotRPM once, early.
        // Initial values are placeholders, they will be updated upon data load/fitting.
        let modelParams = { C: 12.0157, n: 0.3467, R_fixed: 0.0 }; 
        let sweetSpotRPM = 1967; 

        let _isMarkedInitialized = false;
        let heatTransferIntroDismissed = false;
        let mdDataAvailable = false;
        let defaultCsvLoadedSuccessfully = false;
        let defaultMdLoadedSuccessfully = false;

        // UI Elements
        let csvFileInput, csvFileStatus, mdFileInput, mdFileStatus, detailsMarkdownHostDiv, detailsFallbackMessageP;
        let mainNav, mainContent, navTabs, contentSections, rpmSlider, rpmSliderMinLabel, rpmSliderMaxLabel;
        let chartOverlays = {};
        let heatTransferIntroModal, dismissHeatTransferIntroButton;
        let topUploadContainer, bottomFileUploadArea, bottomCsvFileInput, bottomMdFileInput, bottomCsvFileStatus, bottomMdFileStatus;

        // Page Guide Elements & State
        let pageGuideModal, guideSlideTitle, guideSlideContent, guidePrevButton, guideNextButton, guideSkipButton, guideDoneButton, guideSlideIndicator;
        let guideViewDemoButton, currentDemoSlideIndex = 0;
        const localStorageKeyDemoSeen = 'cpuStressEmuDemoSeen_v1.0'; // Versioned key
        
        // Define model functions after modelParams is declared, and before demoSlides
        const rthModel = (rpm) => modelParams.R_fixed + modelParams.C / Math.pow(rpm, modelParams.n);
        const derivativeModel = (rpm) => -modelParams.n * modelParams.C * Math.pow(rpm, -modelParams.n - 1);
        const demoSlides = [
            {
                title: "Welcome to the CPU Thermal Report!",
                contentHTML: `
                    <p>This interactive report helps you explore CPU thermal performance.</p>
                    <p>Let's take a quick tour of the main features (this will only appear once).</p>
                `
            },
            {
                title: "1. Loading Data",
                contentHTML: `
                    <p>The report starts by attempting to load default experiment data (CSV) and detailed explanations (Markdown) from local files named <code>cpu_cooling_data_processed.csv</code> and <code>exp.md</code>.</p>
                    <div class="my-3 p-3 border border-slate-300 rounded-md bg-slate-100 text-xs">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div class="p-3 bg-white border-2 border-dashed border-slate-300 rounded text-center">
                                <h4 class="text-sm font-semibold text-slate-700 mb-1">1. Load CSV Data</h4>
                                <p class="text-slate-500 mb-1">Select a CSV file...</p>
                                <div class="p-1 bg-slate-200 border border-slate-300 rounded w-4/5 mx-auto">Choose File</div>
                            </div>
                            <div class="p-3 bg-white border-2 border-dashed border-slate-300 rounded text-center">
                                <h4 class="text-sm font-semibold text-slate-700 mb-1">2. Load Details (MD)</h4>
                                <p class="text-slate-500 mb-1">Select an MD file...</p>
                                <div class="p-1 bg-slate-200 border border-slate-300 rounded w-4/5 mx-auto">Choose File</div>
                            </div>
                        </div>
                    </div>
                    <p>If default files aren't found or you wish to use your own, you can use the 'Choose File' buttons shown above (in the main app) or in the 'Change Loaded Files' section at the bottom of the page.</p>
                    <p>Once CSV data is successfully loaded, the main navigation and content areas will become active.</p>
                `
            },
            {
                title: "2. Navigating Sections",
                contentHTML: `
                    <p>Use the top navigation bar (which appears after data is loaded) to switch between different views:</p>
                    <div class="my-3 p-2 border-b border-slate-300 bg-slate-100 rounded-t-md">
                        <ul class="flex flex-wrap justify-center text-xs font-medium text-center text-slate-500">
                            <li class="mr-1"><button class="inline-block p-2 border-b-2 border-sky-500 text-sky-600 rounded-t-sm">Overview</button></li>
                            <li class="mr-1"><button class="inline-block p-2 border-b-2 border-transparent rounded-t-sm hover:text-slate-600">Performance</button></li>
                            <li class="mr-1"><button class="inline-block p-2 border-b-2 border-transparent rounded-t-sm hover:text-slate-600">Model</button></li>
                            <li><button class="inline-block p-2 border-b-2 border-transparent rounded-t-sm hover:text-slate-600">Details</button></li>
                        </ul>
                    </div>
                    <ul class="list-disc list-inside ml-4 space-y-1">
                        <li><strong>Overview:</strong> Key findings and a summary of the experiment.</li>
                        <li><strong>Performance Explorer:</strong> Interactive charts for temperature, power, and fan RPM.</li>
                        <li><strong>Thermal Model:</strong> Explore the fitted physics-based model, its predictions, and the 'sweet spot' for fan speed.</li>
                        <li><strong>Experiment Details:</strong> In-depth information, methodology, and analysis (from the loaded Markdown file). This section also includes a brief primer on heat transfer concepts if it's your first time viewing it.</li>
                    </ul>
                `
            },
            {
                title: "3. Interactive Charts & Model",
                contentHTML: `
                    <p>The 'Performance Explorer' and 'Thermal Model' tabs feature interactive charts.</p>
                    <div class="my-3 p-3 border border-slate-300 rounded-md bg-white shadow">
                        <div class="w-full h-32 bg-slate-50 border border-slate-200 rounded flex items-center justify-center relative">
                            <span class="text-slate-400 italic text-sm">Chart Area Example</span>
                            <svg viewBox="0 0 100 50" class="absolute w-4/5 h-4/5 opacity-30 pointer-events-none">
                                <polyline fill="none" stroke="#0ea5e9" stroke-width="2" points="5,45 20,30 40,35 60,15 80,20 95,5" />
                                <line x1="5" y1="45" x2="95" y2="45" stroke="#94a3b8" stroke-width="1"/>
                                <line x1="5" y1="45" x2="5" y2="5" stroke="#94a3b8" stroke-width="1"/>
                            </svg>
                        </div>
                    </div>
                    <p>Hover over data points to see detailed values. The charts will update if you load new CSV data.</p>
                    <p class="mt-3">In the 'Thermal Model' tab, you can also use a slider to see predicted thermal resistance (R<sub>th</sub>) at different RPMs based on the fitted model: <code>R<sub>th</sub> = ${modelParams.R_fixed > 0 ? modelParams.R_fixed.toFixed(3) + " + " : ""}${modelParams.C.toFixed(2)} / RPM<sup>${modelParams.n.toFixed(3)}</sup></code>.</p>
                    <div class="my-3 p-3 border border-slate-300 rounded-md bg-slate-50 text-xs">
                        <p class="text-center font-mono text-sky-700 mb-2">R<sub>th</sub> = ${modelParams.R_fixed > 0 ? modelParams.R_fixed.toFixed(3) + " + " : ""}${modelParams.C.toFixed(2)} / RPM<sup>${modelParams.n.toFixed(3)}</sup></p>
                        <div class="flex items-center space-x-2">
                            <span class="font-medium w-16 text-right">300 RPM</span>
                            <input type="range" min="300" max="2500" value="1500" class="w-full h-1.5 bg-slate-300 rounded-lg appearance-none" disabled>
                            <span class="font-medium w-16 text-left">2500 RPM</span>
                        </div>
                        <div class="text-center mt-2">
                            <p class="text-slate-600">For <span class="font-bold text-slate-800">1500</span> RPM, predicted R<sub>th</sub> is:</p>
                            <p class="text-xl font-bold text-sky-600 mt-0.5">${rthModel(1500).toFixed(3)} °C/W</p>
                        </div>
                    </div>
                `
            },
            {
                title: "4. Experiment Details & Markdown",
                contentHTML: `
                    <p>The 'Experiment Details' tab renders content from a Markdown (.md) file. This allows for rich text formatting, including equations (using KaTeX), code blocks, lists, and images.</p>
                    <p>If you load your own Markdown file, ensure it's well-formatted. The system uses the 'marked-katex-extension' for rendering.</p>
                    <p>The first time you visit the 'Details' tab, an introductory note on heat transfer principles will be shown. You can dismiss it to view the main content.</p>
                `
            },
            {
                title: "You're All Set!",
                contentHTML: `
                    <p>You can now explore the report. If you need to change the loaded data files later, scroll to the bottom of the page to find the 'Change Loaded Files' section.</p>
                    <p>Enjoy analyzing the CPU thermal performance!</p>
                `
            }
        ];

        const showChartOverlays = (show = true) => {
            Object.values(chartOverlays).forEach(overlay => {
                if (overlay) overlay.style.display = show ? 'flex' : 'none';
            });
        };

        const parseCSVData = (csvText) => {
            const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error("CSV must have a header row and at least one data row.");
            
            const headers = lines[0].split(',').map(h => h.trim());
            const requiredHeaders = ['CPU_Power_W_Actual', 'CPU_Temp_C', 'CPU_Fan_RPM', 'Ambient_Temp_C', 'Set_PPT_W'];
            for (const reqHeader of requiredHeaders) {
                if (!headers.includes(reqHeader)) {
                    throw new Error(`Missing required CSV header: ${reqHeader}. Found: ${headers.join(', ')}`);
                }
            }

            processedData = lines.slice(1).map(line => {
                const values = line.split(',');
                const row = {};
                headers.forEach((header, index) => {
                    const val = values[index] ? values[index].trim() : '';
                    if (['CPU_Power_W_Actual', 'CPU_Temp_C', 'Ambient_Temp_C', 'CPU_Fan_RPM', 'Set_PPT_W', 'Mprime_Threads'].includes(header)) {
                        row[header] = parseFloat(val); 
                         if (['CPU_Fan_RPM', 'Set_PPT_W', 'Mprime_Threads'].includes(header) && !isNaN(row[header])) {
                            row[header] = parseInt(row[header], 10);
                        }
                    } else {
                        row[header] = val;
                    }
                });

                if (row.CPU_Power_W_Actual >= 1 && !isNaN(row.CPU_Temp_C) && !isNaN(row.Ambient_Temp_C)) {
                    row.Rth = (row.CPU_Temp_C - row.Ambient_Temp_C) / row.CPU_Power_W_Actual;
                } else {
                    row.Rth = null;
                }
                return row;
            }).filter(row => !isNaN(row.CPU_Power_W_Actual) && row.CPU_Power_W_Actual !== undefined); 
            
            if(processedData.length === 0) throw new Error("No valid data rows found after parsing.");
        };
        
        const updateOverviewStats = () => {
            document.getElementById('statAirflow').textContent = "Strong"; 
            document.getElementById('modelEquationDisplay').innerHTML = `R<sub>th</sub> = ${modelParams.R_fixed.toFixed(3)} + ${modelParams.C.toFixed(2)} / RPM<sup>${modelParams.n.toFixed(3)}</sup>`;
            document.getElementById('statModel').innerHTML = `R<sub>th</sub> = ${modelParams.C.toFixed(2)} / RPM<sup>${modelParams.n.toFixed(3)}</sup>`;
            
            if (processedData.length > 0) {
                const rpms = processedData.map(d => d.CPU_Fan_RPM).filter(rpm => rpm > 0 && !isNaN(rpm));
                if (rpms.length > 0) {
                    const maxRpm = Math.max(...rpms);
                    sweetSpotRPM = Math.min(Math.round(maxRpm * 0.75), 2200); 
                    if (rpms.length > 0 && sweetSpotRPM < Math.min(...rpms)) sweetSpotRPM = Math.round((Math.min(...rpms) + maxRpm)/2);
                }
            }
            document.getElementById('statSweetSpot').innerHTML = `~${sweetSpotRPM}<span class="stat-card-unit">RPM</span>`;
        };

        const initCalculator = () => {
            const slider = document.getElementById('rpmSlider');
            const rpmValueDisplay = document.getElementById('rpmValue');
            const rthValueDisplay = document.getElementById('rthValue');

            const updateCalculatorDisplay = () => {
                if ((processedData.length === 0 && slider.disabled) || !slider ) { 
                    rthValueDisplay.textContent = "N/A";
                    rpmValueDisplay.textContent = slider ? slider.value : "N/A"; 
                    return;
                }
                const rpm = parseInt(slider.value);
                rpmValueDisplay.textContent = rpm;
                rthValueDisplay.textContent = rthModel(rpm).toFixed(3);
            };

            if(slider) slider.addEventListener('input', updateCalculatorDisplay);
            updateCalculatorDisplay(); 
        };

        function checkAndManageTopUploadVisibility() {
            if (defaultCsvLoadedSuccessfully && defaultMdLoadedSuccessfully) {
                if (topUploadContainer) topUploadContainer.style.display = 'none';
                if (bottomFileUploadArea) bottomFileUploadArea.style.display = 'block'; // Use block for this layout
            } else {
                if (topUploadContainer) topUploadContainer.style.display = 'grid'; // Default display for grid
                if (bottomFileUploadArea) bottomFileUploadArea.style.display = 'none';
            }
        }

        function handleSuccessfulCsvLoad(fileName, dataLength, primaryStatusEl, secondaryStatusEl) {
            primaryStatusEl.textContent = `${fileName} loaded successfully. ${dataLength} records found.`;
            if(secondaryStatusEl) secondaryStatusEl.textContent = `${fileName} loaded. (${dataLength} records)`;
            
            mainNav.classList.remove('hidden');
            mainContent.classList.remove('hidden');
            
            const rpms = processedData.map(d => d.CPU_Fan_RPM).filter(rpm => rpm > 0 && !isNaN(rpm));
            const minExpRPM = rpms.length > 0 ? Math.min(...rpms) : 300;
            const maxExpRPM = rpms.length > 0 ? Math.max(...rpms) : 2500;
            rpmSlider.min = minExpRPM;
            rpmSlider.max = maxExpRPM;
            rpmSlider.value = Math.round((minExpRPM + maxExpRPM) / 2);
            rpmSliderMinLabel.textContent = `${minExpRPM} RPM`;
            rpmSliderMaxLabel.textContent = `${maxExpRPM} RPM`;
            rpmSlider.disabled = false;
            
            showChartOverlays(false);
            updateOverviewStats(); 
            initCalculator(); 

            const activeTabButton = document.querySelector('.nav-button.active');
            if (activeTabButton) {
                createChartsForActiveTab(activeTabButton.dataset.tab);
            } else if (navTabs.length > 0) {
                navTabs[0].click(); 
            }
        }

        function handleResetCsvLoadError(fileName, errorMessage, primaryStatusEl, secondaryStatusEl) {
            console.error("Error with CSV:", errorMessage);
            primaryStatusEl.textContent = `Error with ${fileName}. ${errorMessage}`;
            if(secondaryStatusEl) secondaryStatusEl.textContent = `Error with ${fileName}.`;

            mainNav.classList.add('hidden');
            mainContent.classList.add('hidden');
            rpmSlider.disabled = true;
            showChartOverlays(true);
            destroyAllCharts();
            processedData = [];
            updateOverviewStats(); 
            initCalculator(); 
        }
        
        function manageDetailsTabContent() {
            const activeTabButton = document.querySelector('.nav-button.active');
            if (activeTabButton && activeTabButton.dataset.tab !== 'details') {
                heatTransferIntroModal.style.display = 'none'; // Hide if not on details tab
                return;
            }

            if (mdDataAvailable) {
                detailsFallbackMessageP.style.display = 'none';
                if (!heatTransferIntroDismissed) {
                    heatTransferIntroModal.style.display = 'block';
                    detailsMarkdownHostDiv.style.display = 'none';
                } else {
                    heatTransferIntroModal.style.display = 'none';
                    detailsMarkdownHostDiv.style.display = 'block';
                }
            } else { // No MD data yet, or error
                heatTransferIntroModal.style.display = 'none';
                detailsMarkdownHostDiv.style.display = 'none';
                detailsFallbackMessageP.style.display = 'block'; 
                // Fallback message content might be updated by error handler
            }
        }


        function handleSuccessfulMdLoad(fileName, markdownText, primaryStatusEl, secondaryStatusEl) {
            mdDataAvailable = true;
            if (_isMarkedInitialized) {
                const htmlContent = marked.parse(markdownText);
                detailsMarkdownHostDiv.innerHTML = htmlContent;
                primaryStatusEl.textContent = `${fileName} loaded and rendered.`;
                if(secondaryStatusEl) secondaryStatusEl.textContent = `${fileName} loaded.`;
            } else {
                detailsMarkdownHostDiv.innerHTML = "<p class='text-red-500 font-semibold'>Markdown renderer could not be initialized.</p>";
                primaryStatusEl.textContent = `Error: Markdown renderer not initialized for ${fileName}.`;
                 if(secondaryStatusEl) secondaryStatusEl.textContent = `Error: MD renderer issue.`;
            }
            manageDetailsTabContent();
        }
        
        function handleMdLoadError(fileName, errorMessage, primaryStatusEl, secondaryStatusEl) {
            mdDataAvailable = false;
            console.error("Error with Markdown:", errorMessage);
            primaryStatusEl.textContent = `Error with ${fileName}. ${errorMessage}`;
            if(secondaryStatusEl) secondaryStatusEl.textContent = `Error with ${fileName}.`;
            detailsMarkdownHostDiv.innerHTML = `<p class="text-red-500 font-semibold">Error loading details: ${errorMessage}</p>`;
            manageDetailsTabContent(); // This will show fallback message area (or error in detailsMarkdownHostDiv if preferred)
        }

        async function loadDefaultCsv() {
            try {
                const response = await fetch('cpu_cooling_data_processed.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                const text = await response.text();
                parseCSVData(text);
                defaultCsvLoadedSuccessfully = true;
                handleSuccessfulCsvLoad('Default CSV', processedData.length, csvFileStatus, bottomCsvFileStatus);
            } catch (error) {
                defaultCsvLoadedSuccessfully = false;
                handleResetCsvLoadError('Default CSV', error.message, csvFileStatus, bottomCsvFileStatus);
                csvFileStatus.textContent += " Please upload a file."; // More specific
            }
            checkAndManageTopUploadVisibility();
        }

        async function loadDefaultMd() {
            try {
                const response = await fetch('exp.md');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                const markdownText = await response.text();
                defaultMdLoadedSuccessfully = true;
                handleSuccessfulMdLoad('Default Markdown', markdownText, mdFileStatus, bottomMdFileStatus);
            } catch (error) {
                defaultMdLoadedSuccessfully = false;
                handleMdLoadError('Default Markdown', error.message, mdFileStatus, bottomMdFileStatus);
                mdFileStatus.textContent += " Please upload a file.";
                 detailsFallbackMessageP.innerHTML = `<p class="text-red-500">Error loading default Markdown: ${error.message}</p>`;
            }
            checkAndManageTopUploadVisibility();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Cache UI elements
            topUploadContainer = document.getElementById('topUploadContainer');
            bottomFileUploadArea = document.getElementById('bottomFileUploadArea');
            csvFileInput = document.getElementById('csvFileInput');
            csvFileStatus = document.getElementById('csvFileStatus');
            mdFileInput = document.getElementById('mdFileInput');
            mdFileStatus = document.getElementById('mdFileStatus');
            bottomCsvFileInput = document.getElementById('bottomCsvFileInput');
            bottomMdFileInput = document.getElementById('bottomMdFileInput');
            bottomCsvFileStatus = document.getElementById('bottomCsvFileStatus');
            bottomMdFileStatus = document.getElementById('bottomMdFileStatus');
            
            // Page Guide UI Elements
            pageGuideModal = document.getElementById('pageGuideModal');
            guideSlideTitle = document.getElementById('guideSlideTitle');
            guideSlideContent = document.getElementById('guideSlideContent');
            guidePrevButton = document.getElementById('guidePrevButton');
            guideNextButton = document.getElementById('guideNextButton');
            guideSkipButton = document.getElementById('guideSkipButton');
            guideDoneButton = document.getElementById('guideDoneButton');
            guideSlideIndicator = document.getElementById('guideSlideIndicator');
            guideViewDemoButton = document.getElementById('guideViewDemoButton');

            detailsMarkdownHostDiv = document.getElementById('detailsMarkdownHost');
            detailsFallbackMessageP = document.getElementById('detailsFallbackMessage');
            heatTransferIntroModal = document.getElementById('heatTransferIntroModal');
            dismissHeatTransferIntroButton = document.getElementById('dismissHeatTransferIntroButton');
            
            mainNav = document.getElementById('mainNav');
            mainContent = document.getElementById('mainContent');
            navTabs = document.querySelectorAll('.nav-button');
            contentSections = document.querySelectorAll('.content-section');
            rpmSlider = document.getElementById('rpmSlider');
            rpmSliderMinLabel = document.getElementById('rpmSliderMinLabel');
            rpmSliderMaxLabel = document.getElementById('rpmSliderMaxLabel');
            chartOverlays = {
                tempVsPower: document.getElementById('tempVsPowerOverlay'),
                tempVsRpm: document.getElementById('tempVsRpmOverlay'),
                ppt: document.getElementById('pptOverlay'),
                rthVsRpm: document.getElementById('rthVsRpmOverlay'),
                derivative: document.getElementById('derivativeOverlay')
            };

            if (typeof marked !== 'undefined' && typeof window.markedKatex === 'function' && typeof katex !== 'undefined') {
                try {
                    marked.use(window.markedKatex({ throwOnError: false, errorColor: '#FF0000' }));
                    _isMarkedInitialized = true;
                } catch (e) { console.error("Error initializing marked-katex-extension:", e); }
            } else { console.warn("Marked.js, KaTeX, or marked-katex-extension not loaded."); }

            mainNav.classList.add('hidden');
            mainContent.classList.add('hidden');
            rpmSlider.disabled = true;
            showChartOverlays(true);
            initCalculator(); 
            manageDetailsTabContent(); // Initial state for details tab
            
            // Initialize Page Guide. It will either show the guide (and load data on dismiss)
            // or, if already seen, it will trigger data loading.
            initPageGuide();

            function renderCurrentDemoSlide() {
                if (!pageGuideModal || !demoSlides[currentDemoSlideIndex]) return;
                const slide = demoSlides[currentDemoSlideIndex];
                guideSlideTitle.textContent = slide.title;
                guideSlideContent.innerHTML = slide.contentHTML;
                guideSlideIndicator.textContent = `Step ${currentDemoSlideIndex + 1} of ${demoSlides.length}`;

                guidePrevButton.disabled = currentDemoSlideIndex === 0;
                guidePrevButton.classList.toggle('opacity-50', currentDemoSlideIndex === 0);

                if (currentDemoSlideIndex === demoSlides.length - 1) {
                    guideNextButton.style.display = 'none';
                    guideDoneButton.style.display = 'inline-block';
                    guideViewDemoButton.style.display = 'inline-block';
                } else {
                    guideNextButton.style.display = 'inline-block';
                    guideDoneButton.style.display = 'none';
                    guideViewDemoButton.style.display = 'none';
                }
            }

            function dismissPageGuide() {
                if(pageGuideModal) pageGuideModal.style.display = 'none';
                localStorage.setItem(localStorageKeyDemoSeen, 'true');
                
                // Guide is now dismissed, load default data if it hasn't been successfully loaded yet.
                if (!defaultCsvLoadedSuccessfully) {
                    loadDefaultCsv();
                }
                if (!defaultMdLoadedSuccessfully) {
                    loadDefaultMd();
                }
            }

            function initPageGuide() {
                if (localStorage.getItem(localStorageKeyDemoSeen) !== 'true' && pageGuideModal) {
                    // Guide not seen, show it. Data loading will happen on dismiss.
                    pageGuideModal.style.display = 'flex';
                    currentDemoSlideIndex = 0;
                    renderCurrentDemoSlide();
                } else {
                    // Guide already seen (or modal is not available for some reason), 
                    // hide modal just in case and proceed to load data.
                    if (pageGuideModal) pageGuideModal.style.display = 'none';
                    
                    if (!defaultCsvLoadedSuccessfully) {
                        loadDefaultCsv(); 
                    }
                    if (!defaultMdLoadedSuccessfully) {
                        loadDefaultMd(); 
                    }
                }
            }
            
            function setupFileReader(file, type, primaryStatusEl, secondaryStatusEl) {
                 if (file) {
                    primaryStatusEl.textContent = `Reading ${file.name}...`;
                    if(secondaryStatusEl) secondaryStatusEl.textContent = `Reading ${file.name}...`;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const text = e.target.result;
                            if (type === 'csv') {
                                parseCSVData(text);
                                defaultCsvLoadedSuccessfully = false; // A user file overrides default status for visibility logic
                                checkAndManageTopUploadVisibility();
                                handleSuccessfulCsvLoad(file.name, processedData.length, primaryStatusEl, secondaryStatusEl);
                            } else if (type === 'md') {
                                defaultMdLoadedSuccessfully = false; // A user file overrides default status for visibility logic
                                checkAndManageTopUploadVisibility();
                                handleSuccessfulMdLoad(file.name, text, primaryStatusEl, secondaryStatusEl);
                            }
                        } catch (error) {
                            if (type === 'csv') {
                                handleResetCsvLoadError(file.name, error.message, primaryStatusEl, secondaryStatusEl);
                            } else if (type === 'md') {
                                handleMdLoadError(file.name, error.message, primaryStatusEl, secondaryStatusEl);
                            }
                        }
                    };
                    reader.onerror = () => {
                        const errorMsg = 'File could not be read.';
                        if (type === 'csv') {
                             handleResetCsvLoadError(file.name, errorMsg, primaryStatusEl, secondaryStatusEl);
                        } else if (type === 'md') {
                             handleMdLoadError(file.name, errorMsg, primaryStatusEl, secondaryStatusEl);
                        }
                    };
                    reader.readAsText(file);
                }
            }

            csvFileInput.addEventListener('change', (event) => setupFileReader(event.target.files[0], 'csv', csvFileStatus, bottomCsvFileStatus));
            mdFileInput.addEventListener('change', (event) => setupFileReader(event.target.files[0], 'md', mdFileStatus, bottomMdFileStatus));
            bottomCsvFileInput.addEventListener('change', (event) => setupFileReader(event.target.files[0], 'csv', bottomCsvFileStatus, csvFileStatus));
            bottomMdFileInput.addEventListener('change', (event) => setupFileReader(event.target.files[0], 'md', bottomMdFileStatus, mdFileStatus));
            
            // Page Guide Event Listeners
            if(guideNextButton) guideNextButton.addEventListener('click', () => {
                if (currentDemoSlideIndex < demoSlides.length - 1) {
                    currentDemoSlideIndex++;
                    renderCurrentDemoSlide();
                }
            });
            if(guidePrevButton) guidePrevButton.addEventListener('click', () => {
                if (currentDemoSlideIndex > 0) {
                    currentDemoSlideIndex--;
                    renderCurrentDemoSlide();
                }
            });
            if(guideSkipButton) guideSkipButton.addEventListener('click', dismissPageGuide);
            if(guideDoneButton) guideDoneButton.addEventListener('click', dismissPageGuide);
            if(guideViewDemoButton) guideViewDemoButton.addEventListener('click', () => { window.location.href = 'demo.html'; });

            dismissHeatTransferIntroButton.addEventListener('click', () => {
                heatTransferIntroDismissed = true;
                manageDetailsTabContent();
            });

            const destroyChart = (chartKey) => {
                if (activeCharts[chartKey] && typeof activeCharts[chartKey].destroy === 'function') {
                    activeCharts[chartKey].destroy();
                    delete activeCharts[chartKey];
                }
            };

            const destroyAllCharts = () => {
                Object.keys(activeCharts).forEach(key => destroyChart(key));
            };
            
            const commonChartOptions = {
                responsive: true, maintainAspectRatio: false, animation: { duration: 400 },
                plugins: { legend: { position: 'top', labels: { font: { size: 12 } } },
                    tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.7)', titleFont: { weight: 'bold' }, bodyFont: { size: 12 }, padding: 10,
                        callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null && typeof context.parsed.y !== 'undefined') { label += `${context.parsed.y.toFixed(2)}`; } else if (context.parsed.x !== null && typeof context.parsed.x !== 'undefined' && !label.includes('°C/W')) { label += `${context.parsed.x.toFixed(2)}`; } return label; } }
                    },
                },
                scales: { x: { type: 'linear', title: { display: true, text: 'X-Axis', font: { size: 14, weight: '500' }, color: '#334155' }, grid: { color: '#e2e8f0' }, ticks: { font: { size: 11 }, color: '#475569', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } },
                    y: { type: 'linear', title: { display: true, text: 'Y-Axis', font: { size: 14, weight: '500' }, color: '#334155' }, grid: { color: '#e2e8f0' }, ticks: { font: { size: 11 }, color: '#475569' } }
                }
            };
            
            const createTempVsPowerChart = () => {
                if (!processedData || processedData.length === 0) return;
                destroyChart('tempVsPower');
                const ctx = document.getElementById('tempVsPowerChart').getContext('2d');
                activeCharts.tempVsPower = new Chart(ctx, { type: 'scatter', data: { datasets: [{ label: 'Experimental Data', data: processedData.map(d => ({ x: d.CPU_Power_W_Actual, y: d.CPU_Temp_C, rpm: d.CPU_Fan_RPM })), backgroundColor: processedData.map(d => `hsl(${240 - (d.CPU_Fan_RPM / 2500) * 180}, 70%, 55%)`), pointRadius: 5, pointHoverRadius: 7 }] }, options: { ...commonChartOptions, scales: { x: { ...commonChartOptions.scales.x, title: { display: true, text: 'Actual CPU Power (W)' } }, y: { ...commonChartOptions.scales.y, title: { display: true, text: 'CPU Temperature (°C)' } } }, plugins: { ...commonChartOptions.plugins, tooltip: { ...commonChartOptions.plugins.tooltip, callbacks: { label: (c) => `Temp: ${c.parsed.y.toFixed(1)}°C, Power: ${c.parsed.x.toFixed(1)}W, RPM: ${c.raw.rpm}` } } } } });
            };

            const createTempVsRpmChart = () => {
                if (!processedData || processedData.length === 0) return;
                destroyChart('tempVsRpm');
                const ctx = document.getElementById('tempVsRpmChart').getContext('2d');
                const fanRpms = processedData.map(d => d.CPU_Fan_RPM).filter(r => !isNaN(r) && r > 0);
                const minFanRpm = fanRpms.length > 0 ? Math.min(...fanRpms) : 0;
                activeCharts.tempVsRpm = new Chart(ctx, { type: 'scatter', data: { datasets: [{ label: 'Experimental Data', data: processedData.map(d => ({ x: d.CPU_Fan_RPM, y: d.CPU_Temp_C, power: d.CPU_Power_W_Actual })), backgroundColor: processedData.map(d => `hsl(${(d.CPU_Power_W_Actual / 52) * 50 + 20}, 80%, 60%)`), pointRadius: 5, pointHoverRadius: 7 }] }, options: { ...commonChartOptions, scales: { x: { ...commonChartOptions.scales.x, title: { display: true, text: 'CPU Fan RPM' }, min: Math.max(0, minFanRpm - 50) }, y: { ...commonChartOptions.scales.y, title: { display: true, text: 'CPU Temperature (°C)' } } }, plugins: { ...commonChartOptions.plugins, tooltip: { ...commonChartOptions.plugins.tooltip, callbacks: { label: (c) => `Temp: ${c.parsed.y.toFixed(1)}°C, RPM: ${c.parsed.x.toFixed(0)}, Power: ${c.raw.power.toFixed(1)}W` } } } } });
            };

            const createPptChart = () => {
                if (!processedData || processedData.length === 0) return;
                destroyChart('ppt');
                const ctx = document.getElementById('pptChart').getContext('2d');
                const setPPTs = processedData.map(d => d.Set_PPT_W).filter(val => !isNaN(val));
                const minSetPPT = setPPTs.length > 0 ? Math.min(...setPPTs) : 0;
                const maxSetPPT = setPPTs.length > 0 ? Math.max(...setPPTs) : 100;
                activeCharts.ppt = new Chart(ctx, { type: 'scatter', data: { datasets: [{ label: 'Actual vs. Set Power', data: processedData.map(d => ({ x: d.Set_PPT_W, y: d.CPU_Power_W_Actual })), backgroundColor: '#0ea5e9', pointRadius: 5, pointHoverRadius: 7 }, { type: 'line', label: 'Ideal (1:1)', data: [{x:minSetPPT, y:minSetPPT}, {x:maxSetPPT, y:maxSetPPT}], borderColor: '#334155', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, fill: false }] }, options: { ...commonChartOptions, scales: { x: { ...commonChartOptions.scales.x, title: { display: true, text: 'Set Power Target (W)' } }, y: { ...commonChartOptions.scales.y, title: { display: true, text: 'Actual CPU Power (W)' } } }, plugins: { ...commonChartOptions.plugins, tooltip: { ...commonChartOptions.plugins.tooltip, callbacks: { label: (c) => (c.datasetIndex === 0) ? `Actual: ${c.parsed.y.toFixed(1)}W, Set: ${c.parsed.x.toFixed(0)}W` : null } } } } });
            };
            
            const createRthVsRpmChart = () => {
                 if (!processedData || processedData.length === 0) return;
                 destroyChart('rthVsRpm');
                 const ctx = document.getElementById('rthVsRpmChart').getContext('2d');
                 const modelData = []; const rpms = processedData.map(d => d.CPU_Fan_RPM).filter(rpm => rpm > 0 && !isNaN(rpm));
                 const minExpRPM = rpms.length > 0 ? Math.min(...rpms) : 300; const maxExpRPM = rpms.length > 0 ? Math.max(...rpms) : 2500;
                 for(let rpm = minExpRPM; rpm <= maxExpRPM; rpm += Math.max(10, (maxExpRPM-minExpRPM)/50) ) { if (rpm > 0) modelData.push({x: rpm, y: rthModel(rpm)}); }
                 if (modelData.length === 0 && minExpRPM > 0) { for(let rpm = 300; rpm <= 2500; rpm += 50) modelData.push({x: rpm, y: rthModel(rpm)}); }
                 activeCharts.rthVsRpm = new Chart(ctx, { data: { datasets: [{ label: 'Experimental Rth', data: processedData.filter(d => d.Rth !== null && !isNaN(d.Rth)).map(d => ({ x: d.CPU_Fan_RPM, y: d.Rth })), backgroundColor: '#38bdf8', pointRadius: 5, pointHoverRadius: 7, type: 'scatter' },{ label: 'Fitted Model', data: modelData, borderColor: '#ef4444', borderWidth: 2.5, pointRadius: 0, type: 'line', fill: false, tension: 0.1 }] }, options: { ...commonChartOptions, scales: { x: { ...commonChartOptions.scales.x, title: { display: true, text: 'CPU Fan RPM' }, min: minExpRPM > 0 ? Math.max(0, minExpRPM - 50) : 250, ticks: {...commonChartOptions.scales.x.ticks, stepSize: 250} }, y: { ...commonChartOptions.scales.y, title: { display: true, text: 'Thermal Resistance (°C/W)' } } }, plugins: { ...commonChartOptions.plugins, tooltip: { ...commonChartOptions.plugins.tooltip, callbacks: { label: (c) => { if (c.dataset.label === 'Experimental Rth') return `Exp. Rth: ${c.parsed.y.toFixed(3)} °C/W, RPM: ${c.parsed.x.toFixed(0)}`; if (c.dataset.label === 'Fitted Model') return `Model Rth: ${c.parsed.y.toFixed(3)} °C/W, RPM: ${c.parsed.x.toFixed(0)}`; return `${c.parsed.y.toFixed(3)} °C/W`; } } } } } });
            };

            const createDerivativeChart = () => {
                if (!processedData || processedData.length === 0) return;
                destroyChart('derivative');
                const ctx = document.getElementById('derivativeChart').getContext('2d');
                const modelData = []; const rpms = processedData.map(d => d.CPU_Fan_RPM).filter(rpm => rpm > 0 && !isNaN(rpm));
                const minExpRPM = rpms.length > 0 ? Math.min(...rpms) : 300; const maxExpRPM = rpms.length > 0 ? Math.max(...rpms) : 2500;
                for(let rpm = minExpRPM; rpm <= maxExpRPM; rpm += Math.max(10, (maxExpRPM-minExpRPM)/100)) { if (rpm > 0) modelData.push({x: rpm, y: derivativeModel(rpm)}); }
                if (modelData.length === 0 && minExpRPM > 0) { for(let rpm = 300; rpm <= 2500; rpm += 10) modelData.push({x: rpm, y: derivativeModel(rpm)}); } // Fallback range if no data
                const yValues = modelData.map(p=>p.y).filter(y => isFinite(y)); const minYDerivative = yValues.length > 0 ? Math.min(...yValues) : -0.002; const maxYDerivative = yValues.length > 0 ? Math.max(...yValues) : 0;

                activeCharts.derivative = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            {
                                label: 'Rate of Change of Rth (d(Rth)/d(RPM))',
                                data: modelData,
                                borderColor: '#10b981',
                                borderWidth: 2.5,
                                pointRadius: 0,
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: `Sweet Spot Indicator (~${sweetSpotRPM} RPM)`,
                                data: [{x: sweetSpotRPM, y: minYDerivative * 1.1 }, {x:sweetSpotRPM, y: Math.min(0, maxYDerivative * 0.9) }], // Draw vertical line
                                borderColor: '#f97316',
                                borderWidth: 2,
                                borderDash: [5,5],
                                pointRadius: 0,
                                fill: false,
                                type: 'line'
                            }
                        ]
                    },
                    options: {
                        ...commonChartOptions,
                        scales: {
                            x: {
                                ...commonChartOptions.scales.x,
                                title: { display: true, text: 'CPU Fan RPM' },
                                min: minExpRPM > 0 ? Math.max(0, minExpRPM - 50) : 250,
                                ticks: {...commonChartOptions.scales.x.ticks, stepSize: 250, callback: function(value) { return value.toFixed(0); }}
                            },
                            y: {
                                ...commonChartOptions.scales.y,
                                title: { display: true, text: 'd(Rth)/d(RPM) (°C/W/RPM)' },
                                ticks: {...commonChartOptions.scales.y.ticks, callback: function(value) { return value.toExponential(2);}}
                            }
                        },
                        plugins: {
                            ...commonChartOptions.plugins,
                            tooltip: {
                                ...commonChartOptions.plugins.tooltip,
                                callbacks: {
                                    label: (context) => {
                                        // Only show tooltip for the derivative line, not the sweet spot indicator line
                                        if (context.dataset.label === 'Rate of Change of Rth (d(Rth)/d(RPM))') {
                                            const rpm = context.parsed.x.toFixed(0);
                                            const derivative = context.parsed.y;
                                            // Use toExponential for small values, or toFixed with more precision
                                            const formattedDerivative = derivative.toExponential(2); // e.g., -1.23e-3
                                            return `RPM: ${rpm}, d(Rth)/d(RPM): ${formattedDerivative} °C/W/RPM`;
                                        }
                                        return null; // Hide tooltip for other datasets (like the sweet spot line)
                                    }
                                }
                            }
                        }
                    }
                });
            };
            const createChartsForActiveTab = (tabName) => {
                if (processedData.length === 0) { 
                    showChartOverlays(true); return;
                }
                showChartOverlays(false); 
                destroyAllCharts(); 

                if (tabName === 'performance') { createTempVsPowerChart(); createTempVsRpmChart(); createPptChart(); }
                else if (tabName === 'model') { createRthVsRpmChart(); createDerivativeChart(); }
            };
            
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    navTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    contentSections.forEach(s => s.classList.remove('active'));
                    document.getElementById(tabName).classList.add('active');
                    
                    if (tabName === 'details') {
                        manageDetailsTabContent();
                    } else {
                         if(heatTransferIntroModal) heatTransferIntroModal.style.display = 'none'; // Hide intro if navigating away from details
                        createChartsForActiveTab(tabName);
                    }
                });
            });
        });
    </script>
</body>
</html>