<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive CPU Thermal Performance Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    
    <!-- Deferred JS: Order matters for dependencies if not all are defer or async -->
    <!-- KaTeX JS (dependency for marked-katex-extension) -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- Marked.js (dependency for marked-katex-extension) -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- marked-katex-extension -->
    <script defer src="https://cdn.jsdelivr.net/npm/marked-katex-extension@5.1.4/lib/index.umd.js"></script>

    <!-- Chosen Palette: Slate and Sky Blue -->
    <!-- Application Structure Plan: A tab-based SPA for non-linear exploration. The structure is designed to present information in layers of complexity, from a high-level summary to detailed interactive charts and model exploration. The tabs are: 1) 'Overview' for key takeaways and conclusions, providing instant value. 2) 'Performance Explorer' for interactive analysis of core relationships (Temp vs. Power/RPM). 3) 'Thermal Model' for a deep dive into the report's central analysis, including an interactive model calculator. 4) 'Experiment Details' for context and methodology, now loaded from a user-provided MD file. CSV upload functionality for dynamic data loading. -->
    <!-- Visualization & Content Choices: Key findings are presented as dynamic stat cards for quick consumption. Core relationships are visualized with Chart.js scatter plots, enabling hover-for-details interaction. The central physics model is made tangible with a dedicated chart showing the model fit and an interactive slider to calculate Rth, directly engaging the user with the report's main formula. All textual content is abridged for clarity and presented in clean, readable blocks. All choices adhere to the no-SVG, no-Mermaid, canvas-only constraint. Data is now loaded from a user-provided CSV, and experiment details from an MD file. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; height: 400px; max-height: 50vh; }
        .nav-button { transition: all 0.2s ease-in-out; }
        .nav-button.active { color: #0284c7; border-color: #0284c7; font-weight: 600; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .stat-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); text-align: center; }
        .stat-card-title { font-weight: 500; color: #475569; }
        .stat-card-value { font-weight: 700; color: #0f172a; font-size: 1.875rem; line-height: 2.25rem; }
        .stat-card-unit { font-size: 1rem; color: #64748b; margin-left: 0.25rem; }
        .file-upload-section { text-align: center; padding: 1.5rem; background-color: #f8fafc; border-radius: 0.5rem; margin-bottom: 1rem; border: 2px dashed #cbd5e1; }
        .file-input { display: block; margin: 0.5rem auto; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; max-width: 300px; }
        .charts-disabled-overlay { position: absolute; top:0; left:0; right:0; bottom:0; background-color: rgba(241, 245, 249, 0.8); display:flex; align-items:center; justify-content:center; text-align:center; z-index:10; border-radius: 0.5rem;}
        #detailsContent { padding: 1rem; background-color: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        #detailsContent h1, #detailsContent h2, #detailsContent h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; }
        #detailsContent h1 { font-size: 1.875rem; } /* text-3xl */
        #detailsContent h2 { font-size: 1.5rem; }   /* text-2xl */
        #detailsContent h3 { font-size: 1.25rem; }  /* text-xl */
        #detailsContent p { margin-bottom: 1em; line-height: 1.6; color: #475569; }
        #detailsContent ul, #detailsContent ol { margin-left: 1.5em; margin-bottom: 1em; color: #475569; list-style-position: inside; } /* Added list-style-position */
        #detailsContent li { margin-bottom: 0.25em; }
        #detailsContent a { color: #0284c7; text-decoration: underline; }
        #detailsContent strong { font-weight: 600; }
        #detailsContent em { font-style: italic; }
        #detailsContent code { background-color: #f1f5f9; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
        #detailsContent pre { background-color: #f1f5f9; padding: 1em; border-radius: 0.5rem; overflow-x: auto; }
        #detailsContent pre code { background-color: transparent; padding: 0; margin: 0; font-size: inherit; border-radius: 0; }
        /* KaTeX font size can be adjusted if needed, e.g. .katex { font-size: 1.1em; } */
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-2xl md:text-4xl font-bold text-slate-900">A Thermodynamic Investigation of CPU Cooling</h1>
            <p class="text-md md:text-lg text-slate-600 mt-2">Interactive Analysis of the Noctua NH-L9a-AM4 on AMD Ryzen 5 PRO 4650G</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div id="dataUploadSection" class="file-upload-section">
                <h2 class="text-xl font-semibold mb-2 text-slate-700">1. Load Experiment Data (CSV)</h2>
                <p class="text-slate-500 mb-3 text-sm">Select a CSV file with your experimental data.</p>
                <input type="file" id="csvFileInput" class="file-input" accept=".csv">
                <p id="csvFileStatus" class="text-sm text-slate-500 mt-1"></p>
            </div>
            <div id="mdUploadSection" class="file-upload-section">
                <h2 class="text-xl font-semibold mb-2 text-slate-700">2. Load Details (Markdown)</h2>
                <p class="text-slate-500 mb-3 text-sm">Select an MD file for the 'Experiment Details' section.</p>
                <input type="file" id="mdFileInput" class="file-input" accept=".md,.txt">
                <p id="mdFileStatus" class="text-sm text-slate-500 mt-1"></p>
            </div>
        </div>
        
        <nav id="mainNav" class="mb-8 border-b border-slate-200 hidden">
            <ul class="flex flex-wrap -mb-px justify-center text-sm font-medium text-center text-slate-500">
                <li class="mr-2">
                    <button class="nav-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-slate-600 hover:border-slate-300" data-tab="overview">Overview</button>
                </li>
                <li class="mr-2">
                    <button class="nav-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-slate-600 hover:border-slate-300" data-tab="performance">Performance Explorer</button>
                </li>
                <li class="mr-2">
                    <button class="nav-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-slate-600 hover:border-slate-300" data-tab="model">Thermal Model</button>
                </li>
                <li>
                    <button class="nav-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-slate-600 hover:border-slate-300" data-tab="details">Experiment Details</button>
                </li>
            </ul>
        </nav>

        <main id="mainContent" class="hidden">
            <div id="overview" class="content-section">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-center">Key Findings</h2>
                    <p class="text-center text-slate-600 mb-8">This experimental investigation successfully characterized the thermal performance of the CPU cooling system. Below are the primary conclusions drawn from the analysis.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="stat-card">
                            <h3 class="stat-card-title">Airflow Dependence</h3>
                            <p id="statAirflow" class="stat-card-value text-sky-600">N/A</p>
                            <p class="text-slate-500 mt-2">Higher fan speeds significantly improve cooling performance and lower thermal resistance.</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="stat-card-title">Physics-Based Model</h3>
                            <p id="statModel" class="stat-card-value text-base md:text-lg lg:text-xl p-1">N/A</p>
                            <p class="text-slate-500 mt-2">A model was successfully fitted, accurately describing thermal resistance as a function of fan RPM.</p>
                        </div>
                        <div class="stat-card">
                            <h3 class="stat-card-title">Operational "Sweet Spot"</h3>
                            <p id="statSweetSpot" class="stat-card-value">N/A<span class="stat-card-unit">RPM</span></p>
                            <p class="text-slate-500 mt-2">Beyond this point, increasing fan speed offers diminishing returns on cooling improvement.</p>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-semibold text-center mb-4">Conclusion Summary</h3>
                        <ul class="list-disc list-inside space-y-2 text-slate-700">
                            <li><span class="font-semibold">Power Impact:</span> CPU temperature directly correlates with power consumption, a relationship clearly modulated by fan speed.</li>
                            <li><span class="font-semibold">Power Target Tracking:</span> The CPU generally met its set power targets, with minor deviations observed under various thermal loads.</li>
                            <li><span class="font-semibold">Quantitative Basis:</span> These findings provide a solid, data-driven basis for creating effective thermal management strategies and optimized fan curves.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="performance" class="content-section">
                <div class="space-y-12">
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">CPU Temperature vs. Actual Power</h2>
                        <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">This chart shows how CPU temperature increases with power consumption. Note how higher fan speeds (cooler colors) result in lower temperatures for the same power load.</p>
                        <div class="chart-container"><canvas id="tempVsPowerChart"></canvas></div>
                        <div id="tempVsPowerOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">CPU Temperature vs. CPU Fan RPM</h2>
                        <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">This chart illustrates the direct impact of fan speed on temperature. The cooling effect is most pronounced at higher power loads (brighter colors), with diminishing returns at very high RPMs.</p>
                        <div class="chart-container"><canvas id="tempVsRpmChart"></canvas></div>
                        <div id="tempVsRpmOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">Actual Power vs. Set Power Target</h2>
                         <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">This plot assesses how well the CPU's actual power consumption tracked the targets set during the experiment. The black dashed line represents ideal 1:1 tracking.</p>
                        <div class="chart-container"><canvas id="pptChart"></canvas></div>
                        <div id="pptOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                </div>
            </div>

            <div id="model" class="content-section">
                 <div class="space-y-12">
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">Thermal Resistance Model</h2>
                        <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">Thermal resistance ($R_{th}$) measures cooling efficiency. A physics-based model was fitted to the data, showing how $R_{th}$ decreases as fan RPM increases.</p>
                        <div class="chart-container"><canvas id="rthVsRpmChart"></canvas></div>
                        <div id="rthVsRpmOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                    <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-semibold text-center mb-4">Interactive Model Calculator</h3>
                        <p class="text-center text-slate-600 mb-1">Use the slider to see the predicted thermal resistance based on the model:</p>
                        <p id="modelEquationDisplay" class="text-center font-mono text-sky-700 mb-4">R<sub>th</sub> = C / RPM<sup>n</sup> (Load data for values)</p>
                        <div class="flex items-center space-x-4">
                            <span id="rpmSliderMinLabel" class="font-medium w-20 text-right">300 RPM</span>
                            <input type="range" id="rpmSlider" min="300" max="2500" value="1500" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" disabled>
                            <span id="rpmSliderMaxLabel" class="font-medium w-20 text-left">2500 RPM</span>
                        </div>
                        <div class="text-center mt-4">
                            <p class="text-slate-600">For <span id="rpmValue" class="font-bold text-slate-800">1500</span> RPM, predicted R<sub>th</sub> is:</p>
                            <p class="text-3xl font-bold text-sky-600 mt-1"><span id="rthValue">N/A</span> °C/W</p>
                        </div>
                    </div>
                    <div class="relative">
                        <h2 class="text-2xl font-bold text-center mb-2">Finding the "Sweet Spot"</h2>
                        <p class="text-center text-slate-600 mb-4 max-w-3xl mx-auto">The "sweet spot" occurs where the benefit of increasing fan speed diminishes. This chart shows the rate of change of $R_{th}$. The curve flattens at higher RPMs, indicating less cooling gain per RPM increase.</p>
                        <div class="chart-container"><canvas id="derivativeChart"></canvas></div>
                        <div id="derivativeOverlay" class="charts-disabled-overlay"><p>Load CSV data to view chart.</p></div>
                    </div>
                 </div>
            </div>

            <div id="details" class="content-section">
                <div class="max-w-3xl mx-auto">
                    <div id="detailsContent">
                        <p class="text-center text-slate-500">Please upload a Markdown (.md) file to populate this section.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let processedData = [];
        const activeCharts = {}; 

        let modelParams = { C: 12.0157, n: 0.3467, R_fixed: 0.0 }; 
        let sweetSpotRPM = 1967; 
        let _isMarkedInitialized = false;


        const rthModel = (rpm) => modelParams.R_fixed + modelParams.C / Math.pow(rpm, modelParams.n);
        const derivativeModel = (rpm) => -modelParams.n * modelParams.C * Math.pow(rpm, -modelParams.n - 1);

        document.addEventListener('DOMContentLoaded', () => {
            const csvFileInput = document.getElementById('csvFileInput');
            const csvFileStatus = document.getElementById('csvFileStatus');
            const mdFileInput = document.getElementById('mdFileInput');
            const mdFileStatus = document.getElementById('mdFileStatus');
            const detailsContentDiv = document.getElementById('detailsContent');

            const mainNav = document.getElementById('mainNav');
            const mainContent = document.getElementById('mainContent');
            const navTabs = document.querySelectorAll('.nav-button');
            const contentSections = document.querySelectorAll('.content-section');
            const rpmSlider = document.getElementById('rpmSlider');
            const rpmSliderMinLabel = document.getElementById('rpmSliderMinLabel');
            const rpmSliderMaxLabel = document.getElementById('rpmSliderMaxLabel');
            
            const chartOverlays = {
                tempVsPower: document.getElementById('tempVsPowerOverlay'),
                tempVsRpm: document.getElementById('tempVsRpmOverlay'),
                ppt: document.getElementById('pptOverlay'),
                rthVsRpm: document.getElementById('rthVsRpmOverlay'),
                derivative: document.getElementById('derivativeOverlay')
            };

            // Initialize Marked.js with KaTeX extension
            if (typeof marked !== 'undefined' && typeof window.markedKatex === 'function' && typeof katex !== 'undefined') {
                const extensionOptions = {
                    throwOnError: false, // KaTeX option: if true, KaTeX will throw an error on parse error
                    errorColor: '#FF0000'  // KaTeX option: color of error messages
                };
                marked.use(window.markedKatex(extensionOptions));
                _isMarkedInitialized = true;
                console.log("Marked.js with KaTeX extension initialized successfully.");
            } else {
                console.warn("Marked.js, KaTeX, or marked-katex-extension not loaded. Markdown rendering with LaTeX will not be available.");
                if(typeof marked === 'undefined') console.error("Error: marked.js is not loaded.");
                if(typeof katex === 'undefined') console.error("Error: katex.js is not loaded.");
                if(typeof window.markedKatex !== 'function') console.error("Error: marked-katex-extension is not loaded.");
            }

            const showChartOverlays = (show = true) => {
                Object.values(chartOverlays).forEach(overlay => {
                    if (overlay) overlay.style.display = show ? 'flex' : 'none';
                });
            };
            
            csvFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    csvFileStatus.textContent = `Reading ${file.name}...`;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const text = e.target.result;
                            parseCSVData(text);
                            csvFileStatus.textContent = `${file.name} loaded successfully. ${processedData.length} records found.`;
                            mainNav.classList.remove('hidden');
                            mainContent.classList.remove('hidden');
                            
                            const rpms = processedData.map(d => d.CPU_Fan_RPM).filter(rpm => rpm > 0 && !isNaN(rpm));
                            const minExpRPM = rpms.length > 0 ? Math.min(...rpms) : 300;
                            const maxExpRPM = rpms.length > 0 ? Math.max(...rpms) : 2500;
                            rpmSlider.min = minExpRPM;
                            rpmSlider.max = maxExpRPM;
                            rpmSlider.value = Math.round((minExpRPM + maxExpRPM) / 2);
                            rpmSliderMinLabel.textContent = `${minExpRPM} RPM`;
                            rpmSliderMaxLabel.textContent = `${maxExpRPM} RPM`;
                            rpmSlider.disabled = false;
                            
                            showChartOverlays(false);
                            updateOverviewStats(); 
                            initCalculator(); 
                            if (navTabs.length > 0 && document.querySelector('.nav-button.active') === null) { // Activate first tab if none is active
                                navTabs[0].click(); 
                            } else if (document.querySelector('.nav-button.active')) { // Refresh charts for current tab
                                 createChartsForActiveTab(document.querySelector('.nav-button.active').dataset.tab);
                            }
                        } catch (error) {
                            console.error("Error parsing CSV:", error);
                            csvFileStatus.textContent = `Error parsing ${file.name}. ${error.message}`;
                            mainNav.classList.add('hidden');
                            mainContent.classList.add('hidden');
                            rpmSlider.disabled = true;
                            showChartOverlays(true);
                        }
                    };
                    reader.onerror = () => {
                        csvFileStatus.textContent = `Error reading ${file.name}.`;
                        mainNav.classList.add('hidden');
                        mainContent.classList.add('hidden');
                        rpmSlider.disabled = true;
                        showChartOverlays(true);
                    };
                    reader.readAsText(file);
                }
            });

            mdFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    mdFileStatus.textContent = `Reading ${file.name}...`;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const markdownText = e.target.result;
                            if (_isMarkedInitialized) {
                                const htmlContent = marked.parse(markdownText);
                                detailsContentDiv.innerHTML = htmlContent;
                                mdFileStatus.textContent = `${file.name} loaded and rendered.`;
                            } else {
                                detailsContentDiv.innerHTML = "<p class='text-red-500 font-semibold'>Markdown renderer (Marked.js with KaTeX) could not be initialized. Cannot display content.</p><p class='text-slate-600 mt-2'>Please check the browser console for error messages related to 'marked.js', 'katex.js', or 'marked-katex-extension'. Ensure all scripts are loaded correctly.</p>";
                                mdFileStatus.textContent = `Error: Markdown renderer not initialized.`;
                            }
                        } catch (error) {
                            console.error("Error processing Markdown file with Marked.js:", error);
                            mdFileStatus.textContent = `Error processing ${file.name}.`;
                            detailsContentDiv.innerHTML = `<p class="text-red-500">Error rendering Markdown: ${error.message}</p>`;
                        }
                    };
                    reader.onerror = () => {
                        mdFileStatus.textContent = `Error reading ${file.name}.`;
                        detailsContentDiv.innerHTML = `<p class="text-red-500">Error reading Markdown file.</p>`;
                    };
                    reader.readAsText(file);
                }
            });

            const parseCSVData = (csvText) => {
                const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) throw new Error("CSV must have a header row and at least one data row.");
                
                const headers = lines[0].split(',').map(h => h.trim());
                const requiredHeaders = ['CPU_Power_W_Actual', 'CPU_Temp_C', 'CPU_Fan_RPM', 'Ambient_Temp_C', 'Set_PPT_W'];
                for (const reqHeader of requiredHeaders) {
                    if (!headers.includes(reqHeader)) {
                        throw new Error(`Missing required CSV header: ${reqHeader}. Found: ${headers.join(', ')}`);
                    }
                }

                processedData = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        const val = values[index] ? values[index].trim() : '';
                        if (['CPU_Power_W_Actual', 'CPU_Temp_C', 'Ambient_Temp_C', 'CPU_Fan_RPM', 'Set_PPT_W', 'Mprime_Threads'].includes(header)) {
                            row[header] = parseFloat(val); 
                             if (['CPU_Fan_RPM', 'Set_PPT_W', 'Mprime_Threads'].includes(header) && !isNaN(row[header])) {
                                row[header] = parseInt(row[header], 10);
                            }
                        } else {
                            row[header] = val;
                        }
                    });

                    if (row.CPU_Power_W_Actual >= 1 && !isNaN(row.CPU_Temp_C) && !isNaN(row.Ambient_Temp_C)) {
                        row.Rth = (row.CPU_Temp_C - row.Ambient_Temp_C) / row.CPU_Power_W_Actual;
                    } else {
                        row.Rth = null;
                    }
                    return row;
                }).filter(row => !isNaN(row.CPU_Power_W_Actual) && row.CPU_Power_W_Actual !== undefined); 
                
                if(processedData.length === 0) throw new Error("No valid data rows found after parsing.");
            };

            const updateOverviewStats = () => {
                document.getElementById('statAirflow').textContent = "Strong"; 
                document.getElementById('modelEquationDisplay').innerHTML = `R<sub>th</sub> = ${modelParams.R_fixed.toFixed(3)} + ${modelParams.C.toFixed(2)} / RPM<sup>${modelParams.n.toFixed(3)}</sup>`;
                document.getElementById('statModel').innerHTML = `R<sub>th</sub> = ${modelParams.C.toFixed(2)} / RPM<sup>${modelParams.n.toFixed(3)}</sup>`;
                
                if (processedData.length > 0) {
                    const rpms = processedData.map(d => d.CPU_Fan_RPM).filter(rpm => rpm > 0 && !isNaN(rpm));
                    if (rpms.length > 0) {
                        const maxRpm = Math.max(...rpms);
                        sweetSpotRPM = Math.min(Math.round(maxRpm * 0.75), 2200); 
                        if (sweetSpotRPM < Math.min(...rpms)) sweetSpotRPM = Math.round((Math.min(...rpms) + maxRpm)/2);
                    }
                }
                document.getElementById('statSweetSpot').innerHTML = `~${sweetSpotRPM}<span class="stat-card-unit">RPM</span>`;
            };


            const destroyChart = (chartKey) => {
                if (activeCharts[chartKey] && typeof activeCharts[chartKey].destroy === 'function') {
                    activeCharts[chartKey].destroy();
                    delete activeCharts[chartKey];
                }
            };

            const destroyAllCharts = () => {
                Object.keys(activeCharts).forEach(key => destroyChart(key));
            };
            
            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 400 
                },
                plugins: {
                    legend: {
                        position: 'top',
                         labels: { font: { size: 12 } }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.7)',
                        titleFont: { weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += `${context.parsed.y.toFixed(2)}`;
                                }
                                return label;
                            }
                        }
                    },
                },
                scales: {
                    x: {
                        type: 'linear', 
                        title: { display: true, text: 'X-Axis', font: { size: 14, weight: '500' }, color: '#334155' },
                        grid: { color: '#e2e8f0' },
                        ticks: { 
                            font: { size: 11 }, color: '#475569',
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 10 
                        }
                    },
                    y: {
                        type: 'linear',
                        title: { display: true, text: 'Y-Axis', font: { size: 14, weight: '500' }, color: '#334155' },
                        grid: { color: '#e2e8f0' },
                        ticks: { font: { size: 11 }, color: '#475569' }
                    }
                }
            };
            
            const createTempVsPowerChart = () => {
                if (!processedData || processedData.length === 0) return;
                destroyChart('tempVsPower');
                const ctx = document.getElementById('tempVsPowerChart').getContext('2d');
                const data = {
                    datasets: [{
                        label: 'Experimental Data',
                        data: processedData.map(d => ({ x: d.CPU_Power_W_Actual, y: d.CPU_Temp_C, rpm: d.CPU_Fan_RPM })),
                        backgroundColor: processedData.map(d => `hsl(${240 - (d.CPU_Fan_RPM / 2500) * 180}, 70%, 55%)`),
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                };
                activeCharts.tempVsPower = new Chart(ctx, {
                    type: 'scatter',
                    data: data,
                    options: { ...commonChartOptions,
                        scales: {
                           x: { ...commonChartOptions.scales.x, title: { display: true, text: 'Actual CPU Power (W)' } },
                           y: { ...commonChartOptions.scales.y, title: { display: true, text: 'CPU Temperature (°C)' } }
                        },
                        plugins: { ...commonChartOptions.plugins,
                            tooltip: { ...commonChartOptions.plugins.tooltip,
                                callbacks: {
                                    label: (c) => `Temp: ${c.parsed.y.toFixed(1)}°C, Power: ${c.parsed.x.toFixed(1)}W, RPM: ${c.raw.rpm}`
                                }
                            }
                        }
                    }
                });
            };

            const createTempVsRpmChart = () => {
                if (!processedData || processedData.length === 0) return;
                destroyChart('tempVsRpm');
                const ctx = document.getElementById('tempVsRpmChart').getContext('2d');
                 const data = {
                    datasets: [{
                        label: 'Experimental Data',
                        data: processedData.map(d => ({ x: d.CPU_Fan_RPM, y: d.CPU_Temp_C, power: d.CPU_Power_W_Actual })),
                        backgroundColor: processedData.map(d => `hsl(${(d.CPU_Power_W_Actual / 52) * 50 + 20}, 80%, 60%)`),
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                };
                activeCharts.tempVsRpm = new Chart(ctx, {
                    type: 'scatter',
                    data: data,
                    options: { ...commonChartOptions,
                        scales: {
                           x: { ...commonChartOptions.scales.x, title: { display: true, text: 'CPU Fan RPM' }, min: Math.max(0, Math.min(...processedData.map(d=>d.CPU_Fan_RPM).filter(r => !isNaN(r))) - 50) },
                           y: { ...commonChartOptions.scales.y, title: { display: true, text: 'CPU Temperature (°C)' } }
                        },
                        plugins: { ...commonChartOptions.plugins,
                            tooltip: { ...commonChartOptions.plugins.tooltip,
                                callbacks: {
                                    label: (c) => `Temp: ${c.parsed.y.toFixed(1)}°C, RPM: ${c.parsed.x}, Power: ${c.raw.power.toFixed(1)}W`
                                }
                            }
                        }
                    }
                });
            };

            const createPptChart = () => {
                if (!processedData || processedData.length === 0) return;
                destroyChart('ppt');
                const ctx = document.getElementById('pptChart').getContext('2d');
                const setPPTs = processedData.map(d => d.Set_PPT_W).filter(val => !isNaN(val));
                const minSetPPT = setPPTs.length > 0 ? Math.min(...setPPTs) : 0;
                const maxSetPPT = setPPTs.length > 0 ? Math.max(...setPPTs) : 100;
                const data = {
                    datasets: [{
                        label: 'Actual vs. Set Power',
                        data: processedData.map(d => ({ x: d.Set_PPT_W, y: d.CPU_Power_W_Actual })),
                        backgroundColor: '#0ea5e9', 
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }, {
                        type: 'line',
                        label: 'Ideal (1:1)',
                        data: [{x:minSetPPT, y:minSetPPT}, {x:maxSetPPT, y:maxSetPPT}],
                        borderColor: '#334155', 
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                };
                activeCharts.ppt = new Chart(ctx, {
                    type: 'scatter',
                    data: data,
                    options: { ...commonChartOptions,
                        scales: {
                           x: { ...commonChartOptions.scales.x, title: { display: true, text: 'Set Power Target (W)' } },
                           y: { ...commonChartOptions.scales.y, title: { display: true, text: 'Actual CPU Power (W)' } }
                        },
                        plugins: { ...commonChartOptions.plugins,
                             tooltip: { ...commonChartOptions.plugins.tooltip,
                                callbacks: {
                                    label: (c) => (c.datasetIndex === 0) ? `Actual: ${c.parsed.y.toFixed(1)}W, Set: ${c.parsed.x}W` : null
                                }
                            }
                        }
                    }
                });
            };
            
            const createRthVsRpmChart = () => {
                 if (!processedData || processedData.length === 0) return;
                 destroyChart('rthVsRpm');
                 const ctx = document.getElementById('rthVsRpmChart').getContext('2d');
                 const modelData = [];
                 const rpms = processedData.map(d => d.CPU_Fan_RPM).filter(rpm => rpm > 0 && !isNaN(rpm));
                 const minExpRPM = rpms.length > 0 ? Math.min(...rpms) : 300;
                 const maxExpRPM = rpms.length > 0 ? Math.max(...rpms) : 2500;

                 for(let rpm = minExpRPM; rpm <= maxExpRPM; rpm += (maxExpRPM-minExpRPM)/50 ) { 
                     if (rpm > 0) modelData.push({x: rpm, y: rthModel(rpm)});
                 }
                 if (modelData.length === 0 && minExpRPM > 0) { // Fallback if experimental RPMs are weird
                    for(let rpm = 300; rpm <= 2500; rpm += 50) modelData.push({x: rpm, y: rthModel(rpm)});
                 }


                 const data = {
                    datasets: [{
                        label: 'Experimental Rth',
                        data: processedData.filter(d => d.Rth !== null && !isNaN(d.Rth)).map(d => ({ x: d.CPU_Fan_RPM, y: d.Rth })),
                        backgroundColor: '#38bdf8', 
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        type: 'scatter'
                    },{
                        label: 'Fitted Model',
                        data: modelData,
                        borderColor: '#ef4444', 
                        borderWidth: 2.5,
                        pointRadius: 0,
                        type: 'line',
                        fill: false,
                        tension: 0.1
                    }]
                };
                activeCharts.rthVsRpm = new Chart(ctx, {
                    data: data,
                    options: { ...commonChartOptions,
                        scales: {
                           x: { ...commonChartOptions.scales.x, title: { display: true, text: 'CPU Fan RPM' }, min: minExpRPM > 0 ? Math.max(0, minExpRPM - 50) : 250, ticks: {...commonChartOptions.scales.x.ticks, stepSize: 250} },
                           y: { ...commonChartOptions.scales.y, title: { display: true, text: 'Thermal Resistance (°C/W)' } }
                        },
                         plugins: { ...commonChartOptions.plugins,
                             tooltip: { ...commonChartOptions.plugins.tooltip,
                                callbacks: {
                                    label: (c) => `Rth: ${c.parsed.y.toFixed(3)} °C/W, RPM: ${c.parsed.x.toFixed(0)}`
                                }
                            }
                        }
                    }
                });
            };

            const createDerivativeChart = () => {
                if (!processedData || processedData.length === 0) return;
                destroyChart('derivative');
                const ctx = document.getElementById('derivativeChart').getContext('2d');
                const modelData = [];
                const rpms = processedData.map(d => d.CPU_Fan_RPM).filter(rpm => rpm > 0 && !isNaN(rpm));
                const minExpRPM = rpms.length > 0 ? Math.min(...rpms) : 300;
                const maxExpRPM = rpms.length > 0 ? Math.max(...rpms) : 2500;

                for(let rpm = minExpRPM; rpm <= maxExpRPM; rpm += (maxExpRPM-minExpRPM)/100) { 
                     if (rpm > 0) modelData.push({x: rpm, y: derivativeModel(rpm)});
                }
                 if (modelData.length === 0 && minExpRPM > 0) {  // Fallback if experimental RPMs are weird
                    for(let rpm = 300; rpm <= 2500; rpm += 10) modelData.push({x: rpm, y: derivativeModel(rpm)});
                 }
                
                const yValues = modelData.map(p=>p.y).filter(y => isFinite(y));
                const minYDerivative = yValues.length > 0 ? Math.min(...yValues) : -0.002;
                const maxYDerivative = yValues.length > 0 ? Math.max(...yValues) : 0; 

                const data = {
                    datasets: [{
                        label: 'Rate of Change of Rth (d(Rth)/d(RPM))',
                        data: modelData,
                        borderColor: '#10b981', 
                        borderWidth: 2.5,
                        pointRadius: 0,
                        fill: false,
                        tension: 0.1
                    },{
                        label: `Sweet Spot Indicator (~${sweetSpotRPM} RPM)`, 
                        data: [{x: sweetSpotRPM, y: minYDerivative * 1.1 }, {x:sweetSpotRPM, y: maxYDerivative * 0.9 }], // Adjusted y range for visibility
                        borderColor: '#f97316', 
                        borderWidth: 2,
                        borderDash: [5,5],
                        pointRadius: 0,
                        fill: false,
                        type: 'line'
                    }]
                };
                activeCharts.derivative = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: { ...commonChartOptions,
                        scales: {
                           x: { ...commonChartOptions.scales.x, title: { display: true, text: 'CPU Fan RPM' }, min: minExpRPM > 0 ? Math.max(0, minExpRPM - 50) : 250, ticks: {...commonChartOptions.scales.x.ticks, stepSize: 250, callback: function(value) { return value.toFixed(0); }} },
                           y: { ...commonChartOptions.scales.y, title: { display: true, text: 'd(Rth)/d(RPM) (°C/W/RPM)' }, ticks: {...commonChartOptions.scales.y.ticks, callback: function(value) { return value.toExponential(2);}} } // Use scientific notation for small derivative values
                        }
                    }
                });
            };

            const initCalculator = () => {
                const slider = document.getElementById('rpmSlider');
                const rpmValueDisplay = document.getElementById('rpmValue');
                const rthValueDisplay = document.getElementById('rthValue');

                const updateCalculator = () => {
                    if (processedData.length === 0 && rpmSlider.disabled) { 
                        rthValueDisplay.textContent = "N/A";
                        rpmValueDisplay.textContent = slider.value; 
                        return;
                    }
                    const rpm = parseInt(slider.value);
                    rpmValueDisplay.textContent = rpm;
                    rthValueDisplay.textContent = rthModel(rpm).toFixed(3);
                };

                slider.addEventListener('input', updateCalculator);
                updateCalculator(); 
            };
            
            const createChartsForActiveTab = (tabName) => {
                if (processedData.length === 0) { 
                    showChartOverlays(true);
                    return;
                }
                showChartOverlays(false); 
                // Destroy only charts not on the current tab or all if it's a general refresh logic
                // For simplicity with current structure, destroy all and recreate for active tab.
                destroyAllCharts(); 

                if (tabName === 'performance') {
                    createTempVsPowerChart();
                    createTempVsRpmChart();
                    createPptChart();
                } else if (tabName === 'model') {
                    createRthVsRpmChart();
                    createDerivativeChart();
                }
            };
            
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    navTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    contentSections.forEach(s => s.classList.remove('active'));
                    document.getElementById(tabName).classList.add('active');
                    
                    createChartsForActiveTab(tabName);
                });
            });

            mainNav.classList.add('hidden');
            mainContent.classList.add('hidden');
            showChartOverlays(true);
            initCalculator(); 
        });
    </script>
</body>
</html>